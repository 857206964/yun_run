name: Random Cron

on:
  workflow_run:
    workflows: ["刷步数"]
    types:
      - completed
  workflow_dispatch:

jobs:
  randomize-cron:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT }}  # 必须使用PAT才能触发新workflow
          
      - name: 随机化Cron时间
        run: |
          source cron_convert.sh
          echo "📅 当前配置的小时范围: ${{ vars.CRON_HOURS }}"
          persist_execute_log ${{ github.event_name }} ${{ vars.CRON_HOURS }}
          
      - name: 提交更改
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com
          git add .github/workflows/step.yml
          
          current=`TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S'`
          git diff --staged --quiet || git commit -m "⏰ [${current}] 随机Cron时间 (触发方式: ${{ github.event_name }})"
          git push origin main || git push origin master
